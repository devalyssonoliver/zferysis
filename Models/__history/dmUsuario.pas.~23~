unit dmUsuario;

interface

uses
  System.SysUtils, System.Classes, FireDAC.Comp.Client, Usuario,
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param,
  FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf,
  FireDAC.Stan.Async, FireDAC.DApt, Data.DB, FireDAC.Comp.DataSet,
  dmGerenciadorConexao, uArquivoIni, Conexao, Vcl.Dialogs, uFuncoes,
  System.Variants;

type
  TUsuarioDataModule = class(TDataModule)
    FDQuery: TFDQuery;
    fdQueryConsultarUser: TFDQuery;
  private
    FUsuarioLogado: TUsuario;
  public
    function CarregarUsuario(const Login: String): TUsuario;
    function VerificarCredenciais(const Login, Senha: String): Boolean;
    function Inserir(const Codigo: Integer; Nome, Login, Senha: String;
      Ativo: Boolean): Boolean;
    function Editar(const Codigo: Integer; const Nome, Senha: String): Boolean;
    function Deletar(const Codigo: Integer): Boolean;
    property UsuarioLogado: TUsuario read FUsuarioLogado write FUsuarioLogado;
    procedure BuscarUsuario(const CriterioIndex: Integer; const Valor: Variant);

  end;

var
  UsuarioDataModule: TUsuarioDataModule;

implementation

{%CLASSGROUP 'Vcl.Controls.TControl'}
{$R *.dfm}

procedure TUsuarioDataModule.BuscarUsuario(const CriterioIndex: Integer;
  const Valor: Variant);
begin

  if VarIsNull(Valor) or (Trim(VarToStr(Valor)) = '') then
    raise Exception.Create('Informe um valor válido para a pesquisa.');

  fdQueryConsultarUser.Close;
  fdQueryConsultarUser.SQL.Clear;
  fdQueryConsultarUser.Connection := GerenciadorConexao.fdConn;
  fdQueryConsultarUser.SQL.Text :=
    'SELECT codigo, nome, login FROM public.vusuarios WHERE ';

  case CriterioIndex of
    0: // Código
      begin
        FDQuery.SQL.Add('codigo = :Valor');
        FDQuery.ParamByName('Valor').Value := StrToIntDef(VarToStr(Valor), 0);;
      end;
    1: // Nome
      begin
        FDQuery.SQL.Add('nome ILIKE :Valor');
        FDQuery.ParamByName('Valor').AsString := '%' + VarToStr(Valor) + '%';

      end;
    2: // Login
      begin
        FDQuery.SQL.Add('login ILIKE :Valor');
        FDQuery.ParamByName('Valor').AsString := '%' + VarToStr(Valor) + '%';

      end;
  else
    raise Exception.Create('Critério de pesquisa inválido.');
  end;

  try
    fdQueryConsultarUser.Open;

    if FDQuery.IsEmpty then
      raise Exception.Create
        ('Nenhum usuário encontrado com o critério informado.');

  except
    on E: Exception do
      raise Exception.CreateFmt('Erro ao buscar usuário: %s', [E.Message]);
  end;
end;

function TUsuarioDataModule.CarregarUsuario(const Login: String): TUsuario;
var
  Usuario: TUsuario;
begin
  Result := nil;

  FDQuery.Connection := GerenciadorConexao.fdConn;
  FDQuery.SQL.Text :=
    'SELECT codigo, nome, login, ativo FROM usuarios WHERE login = :login';
  FDQuery.ParamByName('login').AsString := Login;
  FDQuery.Open;

  if not FDQuery.IsEmpty then
  begin
    Usuario := TUsuario.Create;
    Usuario.Codigo := FDQuery.FieldByName('codigo').AsInteger;
    Usuario.Nome := FDQuery.FieldByName('nome').AsString;
    Usuario.Login := FDQuery.FieldByName('login').AsString;
    Usuario.Ativo := FDQuery.FieldByName('ativo').AsBoolean;
    Result := Usuario;
  end;
end;

function TUsuarioDataModule.Inserir(const Codigo: Integer;
  Nome, Login, Senha: String; Ativo: Boolean): Boolean;
begin
  Result := False;

  try
    FDQuery.Connection := GerenciadorConexao.fdConn;
    FDQuery.SQL.Text :=
      'INSERT INTO public.usuarios(nome, login, senha, ativo, data_cadastro) ' +
      'VALUES(:Nome, :Login, MD5(:Senha), :Ativo, :DataCadastro)';
    FDQuery.Params.ParamByName('Nome').AsString := Nome;
    FDQuery.Params.ParamByName('Login').AsString := Login;
    FDQuery.Params.ParamByName('Senha').AsString := Senha;
    FDQuery.Params.ParamByName('Ativo').AsBoolean := Ativo;
    FDQuery.Params.ParamByName('DataCadastro').AsDateTime := Now;

    FDQuery.ExecSQL;
    Result := True;
  except
    on E: Exception do
      MsgBox('Ocorreu um erro! Verifique os campos preenchidos, e tente novamente.',
        E.Message, False, 2);
  end;
end;

function TUsuarioDataModule.Deletar(const Codigo: Integer): Boolean;
begin
  Result := False;

  try
    FDQuery.Connection := GerenciadorConexao.fdConn;
    FDQuery.SQL.Text := 'DELETE FROM public.usuarios WHERE codigo = :codigo';
    FDQuery.Params.ParamByName('codigo').AsInteger := Codigo;

    FDQuery.ExecSQL;
    Result := True;
  except
    on E: Exception do
      MsgBox('O usuário não poderá ser apagado caso já existam ações vinculadas.',
        E.Message, False, 2);
  end;
end;

function TUsuarioDataModule.Editar(const Codigo: Integer;
  const Nome, Senha: String): Boolean;
begin
  Result := False;

  try

    FDQuery.Connection := GerenciadorConexao.fdConn;
    FDQuery.SQL.Text := 'UPDATE public.usuarios SET';

    if Nome <> '' then
      FDQuery.SQL.Text := FDQuery.SQL.Text + 'nome = :nome,';

    if Senha <> '' then
      FDQuery.SQL.Text := FDQuery.SQL.Text + 'senha= MD5(:senha),';

    FDQuery.SQL.Text := Copy(FDQuery.SQL.Text, 1, Length(FDQuery.SQL.Text) - 2);

    FDQuery.SQL.Text := FDQuery.SQL.Text + ' WHERE codigo = :codigo';

    if Nome <> '' then
      FDQuery.Params.ParamByName('nome').Value := Nome;

    if Senha <> '' then
      FDQuery.Params.ParamByName('senha').Value := Senha;

    FDQuery.Params.ParamByName('codigo').Value := Codigo;

    FDQuery.ExecSQL;
  except
    on E: Exception do
      MsgBox('Ocorreu um erro! Verifique os campos preenchidos, e tente novamente.',
        E.Message, False, 2);

  end;
end;

function TUsuarioDataModule.VerificarCredenciais(const Login,
  Senha: String): Boolean;
begin
  FDQuery.Connection := GerenciadorConexao.fdConn;
  FDQuery.SQL.Text :=
    'SELECT 1 FROM public.usuarios WHERE login = :login AND senha = MD5(:senha) AND ativo IS TRUE';
  FDQuery.ParamByName('login').AsString := Login;
  FDQuery.ParamByName('senha').AsString := Senha;
  FDQuery.Open;

  Result := not FDQuery.IsEmpty;

  if Result then
    FUsuarioLogado := CarregarUsuario(Login);
end;

end.
